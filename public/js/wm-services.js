!function(t,n,e){"use strict";wmApp.service("talentHelper",["$location","$http",function(t,n){function r(n){t.search("talents",a(n))}function o(n){t.search("glyphs",l(n))}function i(t,n,e,r,o){var i=o[n].row,a=o[n].tree,l=r[a].total,s=r[a].lastActiveRow;return 0!=t&&(!(l<5*i)&&(!(r.remaining<=0)&&(!(e[n]+t>o[n].maxRank)&&((!o[n].requires||e[o[n].requires]==o[o[n].requires].maxRank)&&(e[n]+=t,r[a].row[i]+=t,r[a].total+=t,r.remaining-=t,s<i&&(r[a].lastActiveRow=i),!0)))))}function a(t){var n=[];for(var e in t)n.push(t[e]);return c(n.join(""))}function l(t){var n=[];for(var e in t)t[e]&&n.push(t[e].uid);return n.join(":")}function s(t,n){for(var e in n)for(var r in n[e])if(r==t)return n[e][r]}function c(t){for(var n="",e=0;e<t.length;e+=2){var r=t[e]+(t[e+1]||"0");n+=h.toChar[r]}return p(f(n))}function u(t){if(!t)return"";for(var n="",e=0;e<t.length;e++)n+=h.toInt[t[e]];return n}function p(t){for(var n="",e=0,r=0;r<t.length;r++)"I"!==t[r]?(n+=t[r],e=0):1===++e?n+=t[r]:2===e?n+=e:n=e<11?n.substring(0,n.length-1)+e:n.substring(0,n.length-2)+e;return n}function v(t){for(var n="",e=0;e<t.length;e++)if("I"!==t[e])n+=t[e];else if(isNaN(t[e+1]))n+=t[e];else{var r=t[e+1];isNaN(t[e+2])||(r+=t[e+2],e++),e++,n+=Array(parseInt(r)+1).join("I")}return n}function f(t){if(!t)return"";for(var n=t.length-1;n>=0&&"I"===t[n];)n--;return t.substring(0,n+1)}function g(t,n){var e=0,r=t-1;if(-1==r)return n[0];for(;r>=0;)e+=n[r],r-=1;return e}var d=e,h={toChar:{"00":"I","01":"V","02":"W","03":"X","04":"Y","05":"Z",10:"a",11:"f",12:"k",13:"p",14:"u",15:"z",20:"b",21:"g",22:"l",23:"q",24:"v",25:"A",30:"c",31:"h",32:"m",33:"r",34:"w",35:"B",40:"d",41:"i",42:"n",43:"s",44:"x",45:"C",50:"e",51:"j",52:"o",53:"t",54:"y",55:"D"},toInt:{I:"00",V:"01",W:"02",X:"03",Y:"04",Z:"05",z:"15",A:"25",B:"35",C:"45",D:"55",a:"10",b:"20",c:"30",d:"40",e:"50",f:"11",g:"21",h:"31",i:"41",j:"51",k:"12",l:"22",m:"32",n:"42",o:"52",p:"13",q:"23",r:"33",s:"43",t:"53",u:"14",v:"24",w:"34",x:"44",y:"54"}};return{initSavedTalents:function(t){d=t},getAllSavedTalents:function(){return d},addSavedTalent:function(t){d.push(t)},removeSavedTalent:function(t){for(var n in d)d[n].id===t&&d.splice(n,1)},initTalents:function(t,n,e,o){n=u(v(n));for(var a in t){var l=parseInt(n[a])||0,s=a;e[a]=0,i(l,s,e,o,t)}r(e)},getUrlTalents:function(){return t.search().talents},changeUrlTalents:r,addPoint:i,removePoint:function(t,n,e,r){var o=r[t].row,i=r[t].tree,a=e[i].lastActiveRow;if(n[t]<=0)return!1;if(r[t].allows)for(l=0;l<r[t].allows.length;l+=1)if(n[r[t].allows[l]]>0)return!1;if(o!=a)for(var l=0;a-l>o;){if(g(a-l,e[i].row)<=5*(a-l))return!1;l+=1}return n[t]-=1,e[i].row[o]-=1,e[i].total-=1,e.remaining+=1,o==a&&0==e[i].row[o]&&(e[i].lastActiveRow-=1),!0},clearTalents:function(t,n,o,i,a){if(a!=e){n.remaining=n.remaining+n[a].total,n[a].total=0,n[a].lastActiveRow=0,n[a].row={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0};for(var l in i)i[l].tree==a&&(t[l]=0)}else{n.remaining=71,n[0]={},n[1]={},n[2]={},n[0].total=0,n[1].total=0,n[2].total=0,n[0].lastActiveRow=0,n[1].lastActiveRow=0,n[2].lastActiveRow=0,n[0].row={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0},n[1].row={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0},n[2].row={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0};for(var l in i)t[l]=0}return r(t),!0},getTalentImgPath:function(t,n,e){return t?"/images/talents/"+n+"/"+e+"/"+t+".jpg":""},getTalentTooltip:function(t,n,e,r,o,i){var a=e[t],l=n.maxRank,s="<h5>"+n.name+"</h5>",c="<h5 class='tooltip-ranks'>"+a+" / "+l+"</h5>",u="",p="",v="",f="",g="<img class='tooltip-talent-image' src='"+r+"'/>";0==a?(f="<span class='tooltip-click-to-learn'>Click or scroll up to learn.</span>",u=o[e[t]]):a<l?(u=o[e[t]-1],p=o[e[t]],i||(v="<div class='tooltip-next-rank'>Next rank:</div>")):(f="<span class='tooltip-click-to-remove'>Right click or scroll down to remove.</span>",u=o[e[t]-1]);return g+"<div class='tooltip-talent'>"+s+c+"<div class='tooltip-description'>"+u+"</div>"+v+"<div class='tooltip-description'>"+p+"</div>"+f+"</div>"},isTalentInactive:function(t,n,e,r){var o=n[t],i=!0;return o.requires&&(i=n[o.requires].maxRank==e[o.requires]),5*o.row>r[o.tree].total||0===e[t]&&0===r.remaining||!i},initGlyphs:function(t,n,e){var r=getUnique(t.split(":")),i=0,a=3;for(var l in r){var c=s(r[l],e);1==c.type?(n[i]=c,i++):(n[a]=c,a++)}o(n)},getUrlGlyphs:function(){return t.search().glyphs},changeUrlGlyphs:o,clearGlyphs:function(){var t=[null,null,null,null,null,null];return o(t),t},getGlyphImgPath:function(t){return t?"http://wow.zamimg.com/images/wow/icons/medium/"+t.icon.toLowerCase()+".jpg":"/images/empty-slots/UI-EmptyBack.png"},getGlyphTooltip:function(t,n,e){t||((t={}).name="<span style=color:gray;>Empty</span>",t.description="<span style=color:#0288FF;font-size:14px;>Left click to add a glyph.</span>");var r="<h5>"+t.name+"</h5>",o="<div class='tooltip-description'>"+t.description+"</div>",i="<img class='tooltip-talent-image' src='"+e+"'/>",a="",l="<div class='tooltip-click-to-remove'>Right click to remove.</div>";return a=1==n?"<div style=color:#02FF66;>Major Glyph</div>":"<div style=color:#02FFA7;>Minor Glyph</div>",t.id||(l=""),i+"<div class='tooltip-talent'>"+r+a+o+l+"</div>"},getTalents:function(t){return n.get("/talent/get",{params:{username:t}})},saveTalent:function(t,e){return n.post("/talent/save",{username:e,name:t.name,classId:t.classId,talents:t.talents,glyphs:t.glyphs,preview:t.preview})},deleteTalent:function(t){return n.post("/talent/delete",{id:t})}}}]),wmApp.service("authAPI",["$http","$localStorage","$window",function(t,n,e){return{registerUser:function(n,e){return t.post("/auth/register",{username:n,password:e})},loginUser:function(n,e){return t.post("/auth/login",{username:n,password:e})},logout:function(){delete n.currentUser,e.location.reload()},decryptToken:function(t){var n=t.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(e.atob(n))},refreshToken:function(n){return t.post("/auth/refreshToken",{token:n})}}}])}(window,document);