!function(t,n,r){"use strict";wmApp.service("talentHelper",["$location","$http",function(t,n){function e(n){t.search("talents",a(n))}function o(n){t.search("glyphs",l(n))}function i(t,n,r,e,o){var i=o[n].row,a=o[n].tree,l=e[a].total,s=e[a].lastActiveRow;return 0!=t&&(!(l<5*i)&&(!(e.remaining<=0)&&(!(r[n]+t>o[n].maxRank)&&((!o[n].requires||r[o[n].requires]==o[o[n].requires].maxRank)&&(r[n]+=t,e[a].row[i]+=t,e[a].total+=t,e.remaining-=t,s<i&&(e[a].lastActiveRow=i),!0)))))}function a(t){var n=[];for(var r in t)n.push(t[r]);return c(n.join(""))}function l(t){var n=[];for(var r in t)t[r]&&n.push(t[r].uid);return n.join(":")}function s(t,n){for(var r in n)for(var e in n[r])if(e==t)return n[r][e]}function c(t){for(var n="",r=0;r<t.length;r+=2){var e=t[r]+(t[r+1]||"0");n+=h.toChar[e]}return p(f(n))}function u(t){if(!t)return"";for(var n="",r=0;r<t.length;r++)n+=h.toInt[t[r]];return n}function p(t){for(var n="",r=0,e=0;e<t.length;e++)"I"!==t[e]?(n+=t[e],r=0):1===++r?n+=t[e]:2===r?n+=r:n=r<11?n.substring(0,n.length-1)+r:n.substring(0,n.length-2)+r;return n}function v(t){for(var n="",r=0;r<t.length;r++)if("I"!==t[r])n+=t[r];else if(isNaN(t[r+1]))n+=t[r];else{var e=t[r+1];isNaN(t[r+2])||(e+=t[r+2],r++),r++,n+=Array(parseInt(e)+1).join("I")}return n}function f(t){if(!t)return"";for(var n=t.length-1;n>=0&&"I"===t[n];)n--;return t.substring(0,n+1)}function g(t,n){var r=0,e=t-1;if(-1==e)return n[0];for(;e>=0;)r+=n[e],e-=1;return r}var h={toChar:{"00":"I","01":"V","02":"W","03":"X","04":"Y","05":"Z",10:"a",11:"f",12:"k",13:"p",14:"u",15:"z",20:"b",21:"g",22:"l",23:"q",24:"v",25:"A",30:"c",31:"h",32:"m",33:"r",34:"w",35:"B",40:"d",41:"i",42:"n",43:"s",44:"x",45:"C",50:"e",51:"j",52:"o",53:"t",54:"y",55:"D"},toInt:{I:"00",V:"01",W:"02",X:"03",Y:"04",Z:"05",z:"15",A:"25",B:"35",C:"45",D:"55",a:"10",b:"20",c:"30",d:"40",e:"50",f:"11",g:"21",h:"31",i:"41",j:"51",k:"12",l:"22",m:"32",n:"42",o:"52",p:"13",q:"23",r:"33",s:"43",t:"53",u:"14",v:"24",w:"34",x:"44",y:"54"}};return{initTalents:function(t,n,r,o){n=u(v(n));for(var a in t){var l=parseInt(n[a])||0,s=a;r[a]=0,i(l,s,r,o,t)}e(r)},getUrlTalents:function(){return t.search().talents},changeUrlTalents:e,addPoint:i,removePoint:function(t,n,r,e){var o=e[t].row,i=e[t].tree,a=r[i].lastActiveRow;if(n[t]<=0)return!1;if(e[t].allows)for(l=0;l<e[t].allows.length;l+=1)if(n[e[t].allows[l]]>0)return!1;if(o!=a)for(var l=0;a-l>o;){if(g(a-l,r[i].row)<=5*(a-l))return!1;l+=1}return n[t]-=1,r[i].row[o]-=1,r[i].total-=1,r.remaining+=1,o==a&&0==r[i].row[o]&&(r[i].lastActiveRow-=1),!0},clearTalents:function(t,n,o,i,a){if(a!=r){n.remaining=n.remaining+n[a].total,n[a].total=0,n[a].lastActiveRow=0,n[a].row={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0};for(var l in i)i[l].tree==a&&(t[l]=0)}else{n.remaining=71,n[0]={},n[1]={},n[2]={},n[0].total=0,n[1].total=0,n[2].total=0,n[0].lastActiveRow=0,n[1].lastActiveRow=0,n[2].lastActiveRow=0,n[0].row={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0},n[1].row={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0},n[2].row={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:0};for(var l in i)t[l]=0}return e(t),!0},getTalentImgPath:function(t,n,r){return t?"/images/talents/"+n+"/"+r+"/"+t+".jpg":""},getTalentTooltip:function(t,n,r,e,o,i){var a=r[t],l=n.maxRank,s="<h5>"+n.name+"</h5>",c="<h5 class='tooltip-ranks'>"+a+" / "+l+"</h5>",u="",p="",v="",f="",g="<img class='tooltip-talent-image' src='"+e+"'/>";0==a?(f="<span class='tooltip-click-to-learn'>Click or scroll up to learn.</span>",u=o[r[t]]):a<l?(u=o[r[t]-1],p=o[r[t]],i||(v="<div class='tooltip-next-rank'>Next rank:</div>")):(f="<span class='tooltip-click-to-remove'>Right click or scroll down to remove.</span>",u=o[r[t]-1]);return g+"<div class='tooltip-talent'>"+s+c+"<div class='tooltip-description'>"+u+"</div>"+v+"<div class='tooltip-description'>"+p+"</div>"+f+"</div>"},isTalentInactive:function(t,n,r,e){var o=n[t],i=!0;return o.requires&&(i=n[o.requires].maxRank==r[o.requires]),5*o.row>e[o.tree].total||0===r[t]&&0===e.remaining||!i},initGlyphs:function(t,n,r){var e=getUnique(t.split(":")),i=0,a=3;for(var l in e){var c=s(e[l],r);1==c.type?(n[i]=c,i++):(n[a]=c,a++)}o(n)},getUrlGlyphs:function(){return t.search().glyphs},changeUrlGlyphs:o,clearGlyphs:function(){var t=[null,null,null,null,null,null];return o(t),t},getGlyphImgPath:function(t){return t?"http://wow.zamimg.com/images/wow/icons/medium/"+t.icon.toLowerCase()+".jpg":"/images/empty-slots/UI-EmptyBack.png"},getGlyphTooltip:function(t,n,r){t||((t={}).name="<span style=color:gray;>Empty</span>",t.description="<span style=color:#0288FF;font-size:14px;>Left click to add a glyph.</span>");var e="<h5>"+t.name+"</h5>",o="<div class='tooltip-description'>"+t.description+"</div>",i="<img class='tooltip-talent-image' src='"+r+"'/>",a="",l="<div class='tooltip-click-to-remove'>Right click to remove.</div>";return a=1==n?"<div style=color:#02FF66;>Major Glyph</div>":"<div style=color:#02FFA7;>Minor Glyph</div>",t.id||(l=""),i+"<div class='tooltip-talent'>"+e+a+o+l+"</div>"},getTalents:function(t){return n.get("/talent/get",{username:t})},saveTalent:function(t,r){return n.post("/talent/save",{username:r,name:t.name,classId:t.classId,talents:t.talents,glyphs:t.glyphs,preview:t.preview})},deleteTalent:function(t){return n.post("/talent/delete",{id:t._id,name:t.name})}}}]),wmApp.service("authAPI",["$http","$localStorage","$window",function(t,n,r){return{registerUser:function(n,r){return t.post("/auth/register",{username:n,password:r})},loginUser:function(n,r){return t.post("/auth/login",{username:n,password:r})},logout:function(){delete n.currentUser,r.location.reload()},decryptToken:function(t){var n=t.split(".")[1].replace("-","+").replace("_","/");return JSON.parse(r.atob(n))},refreshToken:function(n){return t.post("/auth/refreshToken",{token:n})}}}])}(window,document);